# .htaccess para el panel de administración
# Colocar en la raíz del directorio del panel admin

# Activar mod_rewrite
RewriteEngine On

# Bloquear acceso a archivos sensibles
<Files "config/database.php">
    Order allow,deny
    Deny from all
</Files>

<Files "config/database_config.php">
    Order allow,deny
    Deny from all
</Files>

<Files ".env">
    Order allow,deny
    Deny from all
</Files>

<Files "install.sql">
    Order allow,deny
    Deny from all
</Files>

# Proteger contra ataques comunes
<IfModule mod_headers.c>
    # Seguridad XSS
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # CSP básico
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.ckeditor.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data: https://img.youtube.com; frame-src https://www.youtube.com; connect-src 'self'"
</IfModule>

# Limitar tamaño de archivos subidos (20MB)
LimitRequestBody 20971520

# Prevenir hotlinking de imágenes
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^http(s)?://(www\.)?tu-dominio.com [NC]
RewriteCond %{REQUEST_URI} \.(jpe?g|png|gif|bmp)$ [NC]
RewriteRule \.(jpe?g|png|gif|bmp)$ - [F]

# URLs amigables
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^notes/([0-9]+)/?$ notes.php?action=edit&id=$1 [L,QSA]
RewriteRule ^notes/new/?$ notes.php?action=new [L,QSA]
RewriteRule ^api/(.*)$ api/$1 [L,QSA]

# Bloquear acceso directo a directorios
Options -Indexes

# Configurar tipos MIME
<IfModule mod_mime.c>
    AddType application/json .json
    AddType video/mp4 .mp4
    AddType video/webm .webm
</IfModule>

# Compresión GZIP
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Cache para recursos estáticos
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    ExpiresByType video/mp4 "access plus 1 month"
</IfModule>

# Proteger contra ataques de fuerza bruta (requiere mod_evasive)
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        5
    DOSSiteCount        100
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   600
</IfModule>

# Logs de errores (desactivar en producción)
# php_flag log_errors On
# php_value error_log /ruta/a/logs/error.log